# Создание библиотеки

Vala еще не может напрямую создавать динамические или статические библиотеки. Для создания библиотеки используйте ключ -с \(только комиляция\) и линкуйте объектные файлы вашим любимым линкером, таким как libtool или ar.

`$ valac -c ...(исходные файлы)`

`ar cx ...(объектные файлы)`

или компилируя промежуточный C код с помощью gcc.

`$ valac -C ...(исходные файлы)`

`$ gcc -o my-best-library.so --shared -fPIC ...(файлы на C)...`

Пример

Это пример того, как написать простую библиотеку на Vala, а так же как ее скомпилировать и протестировать без предварительной установки.

Сохраните следующий код в файл test.vala. Это код самой настоящей библиотеки, функции которой мы хотим вызывать из нашей главной программы.

```csharp
public class MyLib : Object {

    public void hello() {
        stdout.printf("Hello World, MyLib\n");
    }

    public int sum(int x, int y) {
        return x + y;
    }
}
```

Используйте следующую команду для генерирования файлов test.c, test.h и test.vapi. Это будут С версии нашей библиотеки и VAPI файл, представляющий собой интерфейс к библиотеке.

`$ valac -C -H test.h --library test test.vala --basedir ./`

Теперь компилируем библиотеку:

`$ gcc --shared -fPIC -o libtest.so $(pkg-config --cflags --libs gobject-2.0) test.c`

Сохраните следующий код в файл hello.vala. Этот код будет использовать созданную нами библиотеку.

```csharp
void main() {
    var test = new MyLib();
    test.hello();
    int x = 4, y = 5;
    stdout.printf("The sum of %d and %d is %d\n", x, y, test.sum(x, y));
}
```

Теперь компилируем код библиотеки, указав компилятору на использование только что созданной нами библиотеки.

`$ valac -X -I. -X -L. -X -ltest -o hello hello.vala test.vapi --basedir ./`

Теперь мы может запустить программу. Эта команда говорит, что все требуемые библиотеки будут находится в текущем каталоге.

`$ LD_LIBRARY_PATH=$PWD ./hello`

Вывод программы должен выглядеть так:

```text
Привет Мир, MyLib
Сумма 4 и 5 равна 9
```

С опцией `--gir` вы можете так же создать GObjectIntrospection \(GIR\) файл для вашей библиотеки:

`valac -C test.vala --library test --gir Test-1.0.gir`

GIR файл - это описание API в XML.

Связывание библиотек VAPI файлами.

VAPI файлы являются внешним интерфейсом Vala библиотеки. Когда библиотека написана на Vala, этот файл создается компилятором и содержит все public определения со всех Vala файлов. Для библиотек написанных на С VAPI файл выглядит сложнее, особенно если соглашения об именовании не соответствуют таковым в GLib. В этом случае VAPI файл будет содержать множество определений, как стандартизированный интерфейс на Vala будет транслироваться в С.

Данный процесс обычно состоит из трех шагов,

Запуск vala-gen-introspect для генерации метаданных из С библиотеки.

Добавление дополнительных метаданных для стандартизации интерфейса или для других изменений.

